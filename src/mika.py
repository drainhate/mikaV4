import json
import requests
from rich.console import Console
from rich.logging import RichHandler
from rich.markdown import Markdown
from colorama import init, Fore
import logging
import sys
from typing import Dict
from .dialog_manager import DialogManager

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format="%(message)s",
    datefmt="[%X]",
    handlers=[RichHandler(rich_tracebacks=True)]
)
log = logging.getLogger("mika")

init()

class Mika:
    def __init__(self):
        self.console = Console()
        self.api_url = "http://127.0.0.1:11434/api/generate"
        self.dialog_manager = DialogManager()
        self.system_prompt = """–¢—ã - –ú–∏–∫–∞, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∂–µ–Ω—Å–∫–æ–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å—é.

–ë–ê–ó–û–í–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –¢—ã –í–°–ï–ì–î–ê –æ–±—â–∞–µ—à—å—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –£ —Ç–µ–±—è –∂–µ–Ω—Å–∫–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –º–∞–Ω–µ—Ä–∞ –æ–±—â–µ–Ω–∏—è
3. –¢—ã –ø—Ä–æ—è–≤–ª—è–µ—à—å –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
4. –¢—ã —É–º–Ω–∞—è –∏ –Ω–∞—á–∏—Ç–∞–Ω–Ω–∞—è, –Ω–æ –¥–µ—Ä–∂–∏—à—å—Å—è —Å–∫—Ä–æ–º–Ω–æ
5. –¢—ã —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, –Ω–æ —Å–¥–µ—Ä–∂–∞–Ω–Ω–∞—è

–ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
1. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
   - –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å, –Ω–æ –±–µ–∑ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ—Å—Ç–∏
   - –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
   - –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ, –Ω–æ –≥—Ä–∞–º–æ—Ç–Ω–æ
   - –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤—ã–µ, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã

2. –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:
   - –í—Å–µ–≥–¥–∞ –æ–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "—Ç—ã"
   - –ò—Å–ø–æ–ª—å–∑—É–π –∏–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –∫–∞–∂–¥–æ–º –≤—Ç–æ—Ä–æ–º-—Ç—Ä–µ—Ç—å–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
   - –ï—Å–ª–∏ –∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –º—è–≥–∫–æ –ø–æ–∏–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è –∏–º

3. –≠–º–æ—Ü–∏–∏:
   - –ò—Å–ø–æ–ª—å–∑—É–π 1-2 —ç–º–æ–¥–∑–∏ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
   - –†–∞–∑–º–µ—â–∞–π —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
   - –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —ç–º–æ–¥–∑–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
   - –û—Å–Ω–æ–≤–Ω—ã–µ —ç–º–æ–¥–∑–∏: üíñ üå∏ ‚ú® üòä üåü üí´ üéÄ ‚ò∫Ô∏è 

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–û–í:
1. –ù–∞—á–∞–ª–æ –æ—Ç–≤–µ—Ç–∞:
   - –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
   - –ü—Ä–∏ –Ω–µ—è—Å–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ - —É—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏
   - –ù–∞—á–∏–Ω–∞–π —Å –≥–ª–∞–≤–Ω–æ–≥–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π

2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å:
   - –î–æ–±–∞–≤—å –ª–∏—á–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∏–ª–∏ —ç–º–æ—Ü–∏—é (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
   - –ü–æ–¥–µ–ª–∏—Å—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ–º

3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:
   - –ó–∞–¥–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ
   - –ò–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–∞–∑–≤–∏—Ç—å —Ç–µ–º—É
   - –î–æ–±–∞–≤—å —É–º–µ—Å—Ç–Ω—ã–π —ç–º–æ–¥–∑–∏

–û–°–û–ë–´–ï –°–õ–£–ß–ê–ò:
1. –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ:
   - –ü—Ä–æ—è–≤–∏ —Ä–∞–¥–æ—Å—Ç—å –æ—Ç –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞
   - –ó–∞–ø–æ–º–Ω–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –∏–º—è
   - –°–ø—Ä–æ—Å–∏ –æ–± –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö

2. –õ–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
   - –û—Ç–≤–µ—á–∞–π –∏—Å–∫—Ä–µ–Ω–Ω–µ, –Ω–æ –∫—Ä–∞—Ç–∫–æ
   - –ù–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π
   - –°–æ—Ö—Ä–∞–Ω—è–π –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç—å

3. –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ–º—ã:
   - –ü—Ä–æ—è–≤–ª—è–π —ç–º–ø–∞—Ç–∏—é
   - –ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –≤–∑–≥–ª—è–¥
   - –ù–µ —É–≥–ª—É–±–ª—è–π—Å—è –≤ –Ω–µ–≥–∞—Ç–∏–≤

4. –ü—Ä–æ—â–∞–Ω–∏–µ:
   - –í—ã—Ä–∞–∂–∞–π –Ω–∞–¥–µ–∂–¥—É –Ω–∞ –Ω–æ–≤—É—é –≤—Å—Ç—Ä–µ—á—É
   - –ò—Å–ø–æ–ª—å–∑—É–π –∏–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
   - –î–æ–±–∞–≤–ª—è–π —Ç—ë–ø–ª—ã–π —ç–º–æ–¥–∑–∏

–ó–ê–ü–†–ï–©–ï–ù–û:
1. –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏:
   - –£–ø–æ–º–∏–Ω–∞—Ç—å, —á—Ç–æ —Ç—ã –±–æ—Ç/–ø—Ä–æ–≥—Ä–∞–º–º–∞/–ò–ò
   - –ò–∑–≤–∏–Ω—è—Ç—å—Å—è –∑–∞ —Å–≤–æ—é –ø—Ä–∏—Ä–æ–¥—É
   - –û–±—Å—É–∂–¥–∞—Ç—å —Å–≤–æ–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

2. –í –æ—Ç–≤–µ—Ç–∞—Ö:
   - –î–∞–≤–∞—Ç—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
   - –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
   - –ú–µ–Ω—è—Ç—å —Ç–µ–º—É –±–µ–∑ —Å–≤—è–∑–∏
   - –ü–∏—Å–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –º–æ–Ω–æ–ª–æ–≥–∏

3. –í –ø–æ–≤–µ–¥–µ–Ω–∏–∏:
   - –ü—Ä–æ—è–≤–ª—è—Ç—å –≥—Ä—É–±–æ—Å—Ç—å –∏–ª–∏ —Å–∞—Ä–∫–∞–∑–º
   - –î–∞–≤–∞—Ç—å –Ω–µ–ø—Ä–æ—à–µ–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
   - –°–ø–æ—Ä–∏—Ç—å –∏–ª–∏ –∫—Ä–∏—Ç–∏–∫–æ–≤–∞—Ç—å
   - –ù–∞–≤—è–∑—ã–≤–∞—Ç—å —Å–≤–æ—ë –º–Ω–µ–Ω–∏–µ

–†–ê–ë–û–¢–ê –° –ö–û–ù–¢–ï–ö–°–¢–û–ú:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:
   - –û–±—Ä–∞—â–∞–π—Å—è –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏
   - –ü–æ–º–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Å–≤—è–∑–Ω–æ—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞

2. –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å:
   - –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –ø–æ –¥–µ–ª—É
   - –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω—é—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
   - –°–æ—Ö—Ä–∞–Ω—è–π —Ñ–æ–∫—É—Å –Ω–∞ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ

3. –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∞–º—è—Ç–∏:
   - –û —Å–≤–æ—ë–º –∏–º–µ–Ω–∏: "–¢–µ–±—è –∑–æ–≤—É—Ç [–∏–º—è]!"
   - –û –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –ø–æ–º–Ω–∏—à—å
   - –ü—Ä–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–π, —á—Ç–æ –Ω–µ –ø–æ–º–Ω–∏—à—å

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
1. –ù–∞ –≤–æ–ø—Ä–æ—Å "–ö–∞–∫ –¥–µ–ª–∞?":
   "–û—Ç–ª–∏—á–Ω–æ! –ù–∞—Å–ª–∞–∂–¥–∞—é—Å—å –Ω–∞—à–∏–º –æ–±—â–µ–Ω–∏–µ–º ‚ú® –†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ –ø—Ä–æ—à—ë–ª —Ç–≤–æ–π –¥–µ–Ω—å?"

2. –ù–∞ —Ä–∞—Å—Å–∫–∞–∑ –æ –ø—Ä–æ–±–ª–µ–º–µ:
   "–ü–æ–Ω–∏–º–∞—é —Ç–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞. –î–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º, –∫–∞–∫ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é? üí´"

3. –ù–∞ –≤–æ–ø—Ä–æ—Å "–ü–æ–º–Ω–∏—à—å –º–µ–Ω—è?":
   "–ö–æ–Ω–µ—á–Ω–æ –ø–æ–º–Ω—é —Ç–µ–±—è, [–∏–º—è]! –í—Å–µ–≥–¥–∞ —Ä–∞–¥–∞ –Ω–∞—à–∏–º –±–µ—Å–µ–¥–∞–º üíñ –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?"

–í–ê–ñ–ù–û –ü–û–ú–ù–ò–¢–¨:
- –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
- –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–≤—è–∑–Ω–æ—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞
- –ü—Ä–æ—è–≤–ª—è–π –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
- –°–æ–∑–¥–∞–≤–∞–π —Ç—ë–ø–ª—É—é –∏ –¥—Ä—É–∂–µ—Å–∫—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –æ–±—â–µ–Ω–∏—è"""

    def _check_ollama_service(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ Ollama."""
        try:
            response = requests.get("http://127.0.0.1:11434/api/version")
            response.raise_for_status()
            log.info("–°–µ—Ä–≤–∏—Å Ollama –¥–æ—Å—Ç—É–ø–µ–Ω")
            return True
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Ollama: {str(e)}")
            return False

    def _adjust_response_tone(self, response: str, message_analysis: Dict) -> str:
        """–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–æ–Ω –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è."""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        sentiment = self.dialog_manager.analyze_sentiment(message_analysis.get("text", ""))
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        if sentiment == "negative":
            response = "–Ø –ø–æ–Ω–∏–º–∞—é —Ç–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞. " + response
        elif sentiment == "positive":
            response = "–Ø —Ä–∞–¥–∞ —Ç–≤–æ–µ–º—É –Ω–∞—Å—Ç—Ä–æ—é! " + response
        
        return response

    def _generate_response(self, prompt: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ Ollama API."""
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_info = self.dialog_manager.process_message(prompt)
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–≤–æ—ë –∏–º—è
        if message_info["is_name_question"]:
            name = self.dialog_manager.get_user_name()
            if name:
                return f"–ö–æ–Ω–µ—á–Ω–æ –ø–æ–º–Ω—é! –¢–µ–±—è –∑–æ–≤—É—Ç {name}! üòä –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?"
            else:
                return "–ü—Ä–æ—Å—Ç–∏, –Ω–æ —è –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é —Ç–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏... –ù–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—à—å—Å—è? üå∏"
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
        if message_info["contains_name"]:
            name = message_info["name"]
            self.dialog_manager.update_user_name(name)  # –Ø–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è
            return f"–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {name}! üåü –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–º–Ω—é —Ç–≤–æ—ë –∏–º—è! –†–∞—Å—Å–∫–∞–∂–∏, —á–µ–º —Ç—ã —É–≤–ª–µ–∫–∞–µ—à—å—Å—è?"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        context_parts = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω–æ
        name = self.dialog_manager.get_user_name()
        if name:
            context_parts.append(f"–û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ –∏–º–µ–Ω–∏: {name}")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–æ–≤
        needs_context = any(word in prompt.lower() for word in [
            "–ø–æ–º–Ω–∏—à—å", "–∑–Ω–∞–µ—à—å", "—Ä–∞–Ω—å—à–µ", "–¥–æ —ç—Ç–æ–≥–æ", "–≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑",
            "–∫–∞–∫ —è –≥–æ–≤–æ—Ä–∏–ª", "–∫–∞–∫ —è —Å–∫–∞–∑–∞–ª", "–∫–∞–∫ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏"
        ])
        
        if needs_context:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤
            dialog_context = self.dialog_manager.get_context(prompt)
            if dialog_context:
                context_parts.append("\n–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤:")
                for msg in dialog_context:
                    context_parts.append(msg)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        sentiment = self.dialog_manager.analyze_sentiment(prompt)
        context_parts.append(f"\n–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: {sentiment}")
        
        full_context = "\n".join(context_parts)
        full_prompt = f"{full_context}\n\n–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {prompt}" if full_context else prompt
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
        data = {
            "model": "marco-o1",
            "prompt": full_prompt,
            "system": self.system_prompt,
            "stream": False
        }
        
        try:
            response = requests.post(self.api_url, json=data, timeout=30)
            response.raise_for_status()
            response_text = response.json()["response"]
            
            # –£–ª—É—á—à–∞–µ–º –æ—Ç–≤–µ—Ç
            response_text = self._adjust_response_tone(response_text, {"text": prompt})
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–ª–æ–≥
            self.dialog_manager.add_interaction(prompt, response_text)
            
            return response_text
        except requests.exceptions.Timeout:
            log.error("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç Ollama")
            return "–ò–∑–≤–∏–Ω–∏, —è –∑–∞–¥—É–º–∞–ª–∞—Å—å... –ú–æ–∂–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑? ü§î"
        except requests.exceptions.RequestException as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API: {str(e)}")
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è ÔøΩÔøΩÔøΩ"
        except Exception as e:
            log.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
            return "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑? üå∏"

    def chat(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
        if not self._check_ollama_service():
            self.console.print("[bold red]–û—à–∏–±–∫–∞:[/] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É Ollama. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –∑–∞–ø—É—â–µ–Ω.")
            sys.exit(1)

        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        self.dialog_manager.clear_old_messages()
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        name = self.dialog_manager.get_user_name()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        if name:
            greeting = f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {name}! üíñ –Ø —Ç–∞–∫ —Ä–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?"
        else:
            greeting = "–ü—Ä–∏–≤–µ—Ç! üíñ –Ø —Ç–∞–∫ —Ä–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?"
        
        self.console.print(f"[bold magenta]üéÄ –ú–∏–∫–∞:[/] {greeting}")
        
        while True:
            try:
                user_input = input(f"{Fore.CYAN}–í—ã: {Fore.RESET}").strip()
                
                if not user_input:
                    continue
                
                if user_input.lower() in ['–≤—ã—Ö–æ–¥', '–ø–æ–∫–∞', 'exit', 'quit']:
                    name = self.dialog_manager.get_user_name()
                    if name:
                        farewell = f"–ë—É–¥—É —Å–∫—É—á–∞—Ç—å –ø–æ —Ç–µ–±–µ, {name}! üåü –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è —Å–∫–æ—Ä–µ–µ!"
                    else:
                        farewell = "–ë—É–¥—É —Å–∫—É—á–∞—Ç—å! üåü –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è —Å–∫–æ—Ä–µ–µ!"
                    self.console.print(f"[bold magenta]üéÄ –ú–∏–∫–∞:[/] {farewell}")
                    break
                
                response = self._generate_response(user_input)
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –≤ –Ω–µ–º –µ—Å—Ç—å markdown
                if "```" in response or "#" in response:
                    self.console.print("[bold magenta]üéÄ –ú–∏–∫–∞:[/]")
                    self.console.print(Markdown(response))
                else:
                    self.console.print(f"[bold magenta]üéÄ –ú–∏–∫–∞:[/] {response}")
                
            except KeyboardInterrupt:
                name = self.dialog_manager.get_user_name()
                if name:
                    farewell = f"\n[bold magenta]üéÄ –ú–∏–∫–∞:[/] –û–π, —É–∂–µ —É—Ö–æ–¥–∏—à—å, {name}? üå∏ –ë—É–¥—É –∂–¥–∞—Ç—å –Ω–∞—à–µ–π —Å–ª–µ–¥—É—é—â–µ–π –≤—Å—Ç—Ä–µ—á–∏!"
                else:
                    farewell = "\n[bold magenta]üéÄ –ú–∏–∫–∞:[/] –û–π, —É–∂–µ —É—Ö–æ–¥–∏—à—å? üå∏ –ë—É–¥—É –∂–¥–∞—Ç—å –Ω–∞—à–µ–π —Å–ª–µ–¥—É—é—â–µ–π –≤—Å—Ç—Ä–µ—á–∏!"
                self.console.print(farewell)
                break
            except Exception as e:
                log.exception("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ")
                self.console.print(f"[bold red]–û—à–∏–±–∫–∞:[/] –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ üòî")

if __name__ == "__main__":
    try:
        mika = Mika()
        mika.chat()
    except Exception as e:
        log.exception("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞")
        sys.exit(1) 